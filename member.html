<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Member | EMS</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link id="appStyle" rel="stylesheet" href="">
</head>
<body data-theme="dark">
    <div class="theme-toggle" onclick="toggleTheme()" title="Toggle Dark/Light Mode">
        <i class="bi bi-moon-fill" id="themeIcon"></i>
    </div>

    <nav class="navbar navbar-expand-lg navbar-dark bg-success">
        <div class="container-fluid">
            <div class="d-flex align-items-center">
                <img id="logoImg" src="" alt="EMS Logo" style="height: 40px; margin-right: 15px; border-radius: 4px;">
                <a class="navbar-brand" href="#" id="appTitle">EMS MEMBER PANEL</a>
            </div>
            <div class="d-flex">
                <span class="navbar-text me-3">Welcome, <span id="sessionName">...</span></span>
                <button class="btn btn-outline-light btn-sm" onclick="logout()">Logout</button>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-md-12">
                <div id="messageAlert" class="alert alert-info d-flex align-items-center mb-4">
                    <i class="bi bi-megaphone-fill me-2"></i>
                    <div id="messageText">Loading message...</div>
                </div>

                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="card bg-primary text-white">
                            <div class="card-body">
                                <h6 class="card-title"><i class="bi bi-clock"></i> Total Working Hours</h6>
                                <h2 class="mb-0" id="totalWorkingHours"><span class="h-display">0 H 0 MIN</span></h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-warning text-dark">
                            <div class="card-body">
                                <h6 class="card-title"><i class="bi bi-pause-circle"></i> Total Out of Service</h6>
                                <h2 class="mb-0" id="totalOutOfService"><span class="h-display">0 H 0 MIN</span></h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-success text-white">
                            <div class="card-body">
                                <h6 class="card-title"><i class="bi bi-check-circle"></i> Net Working Hours</h6>
                                <h2 class="mb-0" id="netWorkingHours"><span class="h-display">0 H 0 MIN</span></h2>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="bi bi-plus-circle"></i> Add Time Entry</h5>
                    </div>
                    <div class="card-body">
                        <form id="addEntryForm" class="row g-3">
                            <div class="col-md-3">
                                <label for="entryDate" class="form-label"><i class="bi bi-calendar3"></i> Date</label>
                                <input type="text" class="form-control" id="entryDate" placeholder="Select date" required readonly>
                            </div>
                            <div class="col-md-2">
                                <label for="entryTimeIn" class="form-label"><i class="bi bi-clock"></i> Time In</label>
                                <input type="time" class="form-control" id="entryTimeIn" required>
                            </div>
                            <div class="col-md-2">
                                <label for="entryTimeOut" class="form-label"><i class="bi bi-clock-fill"></i> Time Out</label>
                                <input type="time" class="form-control" id="entryTimeOut" required>
                            </div>
                            <div class="col-md-2">
                                <label for="entryTotalHours" class="form-label"><i class="bi bi-hourglass-split"></i> Total Hours</label>
                                <input type="text" class="form-control bg-light" id="entryTotalHours" placeholder="Auto" readonly>
                            </div>
                            <div class="col-md-2">
                                <label for="entryOutOfService" class="form-label"><i class="bi bi-pause"></i> Out of Service (min)</label>
                                <input type="number" class="form-control" id="entryOutOfService" placeholder="0" value="0" min="0">
                            </div>
                            <div class="col-md-1 d-flex align-items-end">
                                <button type="submit" class="btn btn-success w-100">
                                    <i class="bi bi-check-circle"></i> Add
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="bi bi-clock-history"></i> My Time Entries</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Time In</th>
                                        <th>Time Out</th>
                                        <th>Total Hours</th>
                                        <th>Out of Service</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="entriesTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="card mt-5">
                    <div class="card-header bg-light">
                        <h6 class="mb-0"><i class="bi bi-key"></i> Change Password</h6>
                    </div>
                    <div class="card-body">
                        <div class="row g-2 align-items-center">
                            <div class="col-md-4">
                                <div class="input-group">
                                    <input type="password" id="memberCurrentPass" class="form-control" placeholder="Current password">
                                    <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordVisibility('memberCurrentPass', 'currentPassIcon')">
                                        <i class="bi bi-eye" id="currentPassIcon"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="input-group">
                                    <input type="password" id="memberNewPass" class="form-control" placeholder="New password">
                                    <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordVisibility('memberNewPass', 'newPassIcon')">
                                        <i class="bi bi-eye" id="newPassIcon"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-outline-primary w-100" onclick="changeMemberPassword()">Update</button>
                            </div>
                            <div class="col-md-2">
                                <div id="memberPassStatus" class="small text-muted"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editEntryModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Time Entry</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editEntryForm">
                        <input type="hidden" id="editEntryId">
                        <div class="mb-3">
                            <label for="editEntryDate" class="form-label"><i class="bi bi-calendar3"></i> Date</label>
                            <input type="text" class="form-control" id="editEntryDate" required readonly>
                        </div>
                        <div class="mb-3">
                            <label for="editEntryTimeIn" class="form-label"><i class="bi bi-clock"></i> Time In</label>
                            <input type="time" class="form-control" id="editEntryTimeIn" required>
                        </div>
                        <div class="mb-3">
                            <label for="editEntryTimeOut" class="form-label"><i class="bi bi-clock-fill"></i> Time Out</label>
                            <input type="time" class="form-control" id="editEntryTimeOut" required>
                        </div>
                        <div class="mb-3">
                            <label for="editEntryTotalHours" class="form-label"><i class="bi bi-hourglass-split"></i> Total Hours</label>
                            <input type="text" class="form-control bg-light" id="editEntryTotalHours" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="editEntryOutOfService" class="form-label"><i class="bi bi-pause"></i> Out of Service (minutes)</label>
                            <input type="number" class="form-control" id="editEntryOutOfService" required min="0">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="updateEntry()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="./config.js"></script>
    <script>
        const cfg = window.APP_CONFIG || {};
        const API_BASE = (cfg.apiBaseUrl || '').replace(/\/$/, '');
        const ASSET_BASE = (cfg.assetBaseUrl || API_BASE).replace(/\/$/, '');
        let sessionUser = null;
        let entries = [];
        let editModal;
        let datePicker, editDatePicker;

        document.getElementById('appStyle').href = `${ASSET_BASE}/static/css/style.css`;
        document.getElementById('logoImg').src = `${ASSET_BASE}/static/ems-logo.jpeg`;
        document.getElementById('appTitle').textContent = `${cfg.appName || 'EMS'} - MEMBER PANEL`;

        function apiFetch(path, options = {}) {
            return fetch(`${API_BASE}${path}`, {
                credentials: 'include',
                headers: { 'Content-Type': 'application/json', ...(options.headers || {}) },
                ...options
            });
        }

        async function ensureSession() {
            const res = await apiFetch('/api/session');
            if (!res.ok) {
                window.location.href = './login.html';
                return;
            }
            const data = await res.json();
            if (!data.authenticated || !data.user || data.user.role !== 'member') {
                window.location.href = './login.html';
                return;
            }
            sessionUser = data.user;
            document.getElementById('sessionName').textContent = sessionUser.name || sessionUser.username;
        }

        function togglePasswordVisibility(inputId, iconId) {
            const input = document.getElementById(inputId);
            const icon = document.getElementById(iconId);
            const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
            input.setAttribute('type', type);
            icon.classList.toggle('bi-eye-slash');
            icon.classList.toggle('bi-eye');
        }

        function toggleTheme() {
            const body = document.body;
            const themeIcon = document.getElementById('themeIcon');
            const next = body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
            body.setAttribute('data-theme', next);
            themeIcon.classList.toggle('bi-moon-fill');
            themeIcon.classList.toggle('bi-sun-fill');
            localStorage.setItem('theme', next);
        }

        function parseMinutes(timeStr) {
            if (!timeStr) return 0;
            if (timeStr.includes(':')) {
                const [h, m] = timeStr.split(':').map(Number);
                return (h || 0) * 60 + (m || 0);
            }
            return parseInt(timeStr, 10) || 0;
        }

        function formatMinutes(minutes) {
            const hrs = Math.floor(minutes / 60);
            const mins = minutes % 60;
            return `${hrs} H ${mins} MIN`;
        }

        function calculateHoursDifference(timeIn, timeOut) {
            const [inH, inM] = timeIn.split(':').map(Number);
            const [outH, outM] = timeOut.split(':').map(Number);
            let inTotal = inH * 60 + inM;
            let outTotal = outH * 60 + outM;
            if (outTotal < inTotal) outTotal += 24 * 60;
            const diff = outTotal - inTotal;
            const h = String(Math.floor(diff / 60)).padStart(2, '0');
            const m = String(diff % 60).padStart(2, '0');
            return `${h}:${m}`;
        }

        function calculateTotals() {
            let totalMinutes = 0;
            let totalOut = 0;
            entries.forEach(entry => {
                totalMinutes += parseMinutes(entry.total_hours);
                totalOut += parseMinutes(entry.out_of_service);
            });
            const net = Math.max(0, totalMinutes - totalOut);
            document.getElementById('totalWorkingHours').innerHTML = formatMinutes(totalMinutes);
            document.getElementById('totalOutOfService').innerHTML = formatMinutes(totalOut);
            document.getElementById('netWorkingHours').innerHTML = formatMinutes(net);
        }

        function renderEntries() {
            const tbody = document.getElementById('entriesTableBody');
            if (!entries.length) {
                tbody.innerHTML = `<tr><td colspan="6" class="text-center text-muted py-4">No duty logs found</td></tr>`;
                return;
            }
            tbody.innerHTML = entries.map(entry => `
                <tr>
                    <td>${entry.date}</td>
                    <td>${entry.time_in}</td>
                    <td>${entry.time_out}</td>
                    <td><strong class="text-primary">${entry.total_hours}</strong></td>
                    <td>${entry.out_of_service}</td>
                    <td>
                        <button class="btn btn-sm btn-warning" onclick="openEditModal(${entry.id})"><i class="bi bi-pencil"></i> Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteEntry(${entry.id})"><i class="bi bi-trash"></i> Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        async function loadEntries() {
            const res = await apiFetch('/api/entries');
            if (!res.ok) {
                entries = [];
            } else {
                const data = await res.json();
                entries = data.entries || [];
            }
            renderEntries();
            calculateTotals();
        }

        async function loadMessage() {
            const res = await apiFetch('/api/message');
            if (!res.ok) return;
            const data = await res.json();
            const text = (data.message || '').trim();
            const messageText = document.getElementById('messageText');
            const alertBox = document.getElementById('messageAlert');
            messageText.textContent = text || 'No message from boss yet.';
            alertBox.classList.toggle('alert-info', !!text);
            alertBox.classList.toggle('alert-secondary', !text);
        }

        document.getElementById('addEntryForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const payload = {
                date: document.getElementById('entryDate').value,
                time_in: document.getElementById('entryTimeIn').value,
                time_out: document.getElementById('entryTimeOut').value,
                total_hours: document.getElementById('entryTotalHours').value,
                out_of_service: document.getElementById('entryOutOfService').value || '0'
            };
            if (!payload.total_hours) {
                payload.total_hours = calculateHoursDifference(payload.time_in, payload.time_out);
            }
            const res = await apiFetch('/api/entries', { method: 'POST', body: JSON.stringify(payload) });
            if (res.ok) {
                document.getElementById('addEntryForm').reset();
                datePicker.setDate(new Date());
                await loadEntries();
            }
        });

        function openEditModal(id) {
            const entry = entries.find(e => e.id === id);
            if (!entry) return;
            document.getElementById('editEntryId').value = entry.id;
            document.getElementById('editEntryDate').value = entry.date;
            document.getElementById('editEntryTimeIn').value = entry.time_in;
            document.getElementById('editEntryTimeOut').value = entry.time_out;
            document.getElementById('editEntryTotalHours').value = entry.total_hours;
            document.getElementById('editEntryOutOfService').value = parseMinutes(entry.out_of_service);
            editDatePicker.setDate(entry.date, true, 'd-m-Y');
            editModal.show();
        }

        async function updateEntry() {
            const id = document.getElementById('editEntryId').value;
            const payload = {
                date: document.getElementById('editEntryDate').value,
                time_in: document.getElementById('editEntryTimeIn').value,
                time_out: document.getElementById('editEntryTimeOut').value,
                total_hours: document.getElementById('editEntryTotalHours').value,
                out_of_service: document.getElementById('editEntryOutOfService').value
            };
            const res = await apiFetch(`/api/entries/${id}`, { method: 'PUT', body: JSON.stringify(payload) });
            if (res.ok) {
                editModal.hide();
                await loadEntries();
            }
        }

        async function deleteEntry(id) {
            if (!confirm('Delete this entry?')) return;
            const res = await apiFetch(`/api/entries/${id}`, { method: 'DELETE' });
            if (res.ok) await loadEntries();
        }

        async function changeMemberPassword() {
            const current_password = document.getElementById('memberCurrentPass').value;
            const new_password = document.getElementById('memberNewPass').value;
            const statusDiv = document.getElementById('memberPassStatus');
            const res = await apiFetch('/api/members/me/password', { method: 'PUT', body: JSON.stringify({ current_password, new_password }) });
            if (res.ok) {
                statusDiv.textContent = 'Updated';
            } else {
                const data = await res.json();
                statusDiv.textContent = data.error || 'Failed';
            }
        }

        async function logout() {
            await apiFetch('/api/logout', { method: 'POST' });
            window.location.href = './login.html';
        }

        document.addEventListener('DOMContentLoaded', async function() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.body.setAttribute('data-theme', savedTheme);
            const themeIcon = document.getElementById('themeIcon');
            themeIcon.classList.toggle('bi-moon-fill', savedTheme === 'dark');
            themeIcon.classList.toggle('bi-sun-fill', savedTheme !== 'dark');

            datePicker = flatpickr('#entryDate', { dateFormat: 'd-m-Y', defaultDate: new Date(), maxDate: new Date() });
            editDatePicker = flatpickr('#editEntryDate', { dateFormat: 'd-m-Y', maxDate: new Date() });
            editModal = new bootstrap.Modal(document.getElementById('editEntryModal'));

            document.getElementById('entryTimeIn').addEventListener('change', () => {
                const ti = document.getElementById('entryTimeIn').value;
                const to = document.getElementById('entryTimeOut').value;
                if (ti && to) document.getElementById('entryTotalHours').value = calculateHoursDifference(ti, to);
            });
            document.getElementById('entryTimeOut').addEventListener('change', () => {
                const ti = document.getElementById('entryTimeIn').value;
                const to = document.getElementById('entryTimeOut').value;
                if (ti && to) document.getElementById('entryTotalHours').value = calculateHoursDifference(ti, to);
            });
            document.getElementById('editEntryTimeIn').addEventListener('change', () => {
                const ti = document.getElementById('editEntryTimeIn').value;
                const to = document.getElementById('editEntryTimeOut').value;
                if (ti && to) document.getElementById('editEntryTotalHours').value = calculateHoursDifference(ti, to);
            });
            document.getElementById('editEntryTimeOut').addEventListener('change', () => {
                const ti = document.getElementById('editEntryTimeIn').value;
                const to = document.getElementById('editEntryTimeOut').value;
                if (ti && to) document.getElementById('editEntryTotalHours').value = calculateHoursDifference(ti, to);
            });

            await ensureSession();
            await loadMessage();
            await loadEntries();
        });
    </script>
</body>
</html>
